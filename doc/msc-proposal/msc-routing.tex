\chapter{6LoWPAN Routing}\label{ch:routing}
Neither the IEEE 802.15.4 \cite{ieee802.15.4} standard nor the 6LoWPAN format specification \cite{rfc4944} define how mesh topologies could be obtained and maintained. In 6LoWPAN routing can be performed either in the IP-layer, using a route over approach, or in the adaptation layer, described in Section \ref{subsec:mesh.header}, using the mesh under approach. The mesh under configuration performs the multi-hop routing below the IP link and therefore the characteristics of IEEE 802.15.4 directly affect the 6LoWPAN routing mechanisms. In this approach a 6LoWPAN is seen as a single IP link and the IPv6 link-local scope covers all nodes in the LoWPAN. In the route over configuration intermediate nodes become LoWPAN Routers and perform standard layer 3 (IP) routing. Therefore, in this case, the link-local scope includes a set of nodes within symmetric radio range of a node and routing can be accomplished over various types of interconnected links.

The IETF Routing Over Low power and Lossy networks working group  (ROLL WG) is focused on routing issues for Low power and Lossy Networks (LLNs)  composed of many embedded devices with limited power, memory, and processing resources interconnected by a variety of links, such as IEEE 802.15.4 or Low Power WiFi. The aim of the group is to provide an IPv6 architectural framework for routing and path selection in LLNs. So far several internet drafts have been published, such as an Overview of Existing Routing Protocols for Low Power and Lossy Networks \cite{draft-protocols-07},  IPv6 Routing Protocol for Low power and Lossy Networks \cite{draft-rpl-04}, and Routing Metrics used for Path Calculation in Low Power and Lossy Networks \cite{draft-routing-metrics-04}. 


\begin{figure}[htp]
\begin{mylisting}
\begin{verbatim}
  +-----------------------------+    +-----------------------------+
  |  Application Layer          |    |  Application Layer          |
  +-----------------------------+    +-----------------------------+
  |  Transport Layer (TCP/UDP)  |    |  Transport Layer (TCP/UDP)  |
  +-----------------------------+    +-----------------------------+
  |  Network Layer (IPv6)       |    |  Network       +---------+  |
  +-----------------------------+    |  Layer         | Routing |  |
  |  6LoWPAN       +---------+  |    |  (IPv6)        +---------+  |
  |  Adaptation    | Routing*|  |    +-----------------------------+
  |  Layer         +---------+  |    |  6LoWPAN Adaptation Layer   |
  +-----------------------------+    +-----------------------------+
  |  IEEE 802.15.4 (MAC)        |    |  IEEE 802.15.4 (MAC)        |
  +-----------------------------+    +-----------------------------+
  |  IEEE 802.15.4 (PHY)        |    |  IEEE 802.15.4 (PHY)        |
  +-----------------------------+    +-----------------------------+
\end{verbatim}
\end{mylisting}
\caption{Mesh Under (left) and Route Over routing (right)}\label{fig:routing}
\end{figure}

Further in this chapter, the list of requirements for 6LoWPAN routing defined in the internet draft \cite{draft-routing-04} is discussed in Section \ref{sec:rout.req}. The evaluation of existing  routing protocol for LLN scenarious is presented in Section \ref{sec:rout.protocols}. And,  finally, Section \ref{sec:rout.rpl} describes the internet draft \cite{draft-rpl-04} which specifies the IPv6 Routing Protocol for LLNs.

\section{6LoWPAN Routing Requirements}\label{sec:rout.req}
A LoWPAN has to support multiple device types and roles such as host nodes drawing their power from primary batteries, mains-powered nodes and power-affluent gateways. Battery-operated devices need to last from several months to a few years with a single AA battery. Therefore 6LoWPAN routing protocols have to cause minimal power consumption by the efficient use of control packets, minimization of expensive IP multicast which causes link broadcast to the entire LoWPAN, and by  efficient routing of data packets. Control messages have to fit into a single IEEE 802.15.4 frame in order to avoid packet fragmentation and the overhead for reassembly. The design of 6LoWPAN routing protocols should be scalable to support networks ranging from a few nodes to millions of nodes.

6LoWPAN devices are unreliable due to limited system capabilities and an unpredictable environment where they can be deployed. 6LoWPAN routing protocols have to be robust to dynamic loss caused by link failure or device unavailability. Moreover, some of the links may be asymmetric, when the probability of successful transmission between two nodes is significantly higher in one direction than in the other one. 6LoWPAN routing protocols have to be designed to correctly operate in the presence of such links.  In addition, latency and successful end-to-end packet delivery ratio requirements of applications must be taken into account.

6LoWPAN devices have small memory sizes, therefore 6LoWPAN routing protocols require implementation with small code size and low routing state to fit the typical 6LoWPAN node capacity. The code size is limited to available flash memory size, and the routing table is bounded by RAM size. 

\section{Existing Routing Protocols}\label{sec:rout.protocols}
The internet draft \cite{draft-protocols-07} provides a survey of the strengths and weaknesses of existing routing protocols with respect to the 6LoWPAN routing requirements. The survey examines whether existing and mature IETF protocols can meet LLN requirements without modifications. The list of considered protocols is OSPF \cite{rfc2328}, IS-IS \cite{rfc1142}, RIP \cite{rfc2453}, OLSR \cite{rfc3626}, OLSv2 \cite{draft-manet-olsrv2}, TBRPF \cite{rfc3684}, AODV \cite{rfc3561}, DYMO \cite{draft-manet-dymo}, and DSR \cite{rfc4728}. 

The survey uses five criteria derived from a set of requirements for routing in low power and lossy networks:  routing state, loss response, control cost, link cost, and node cost. The routing state criterion indicates whether routing state scales reasonably within the memory resources of low-power nodes. Routing state that scales linearly with the size of the network or a node's neighbourhood fails and passes if scales with the number of destinations. The loss response indicates whether the protocol localizes responses to link failures with no triggering of global network re-optimization. Protocols which require many link changes to propagate across the entire network fail. The control cost criterion defines constraints on control traffic, in order to discover a topology. The link and node cost specify how a protocol chooses routes for data packets to take through the network. A protocol passes these criteria if it provides a mechanism allowing link and node properties to be considered when choosing routes.

Table \ref{table:routing.prot.survey} summarizes the survey showing which of existing protocols meet the criteria described above. The detailed analysis is given in \cite{draft-protocols-07}. For each of these criteria, the value "pass" indicates that a protocol has satisfactory performance.  The value "fail" corresponds to not acceptable performance, which means that the protocol does not meet the criterion. Finally, a "?" means that a protocol would require a supplementary document specifying how a protocol should behave. As can be seen from the table, no existing IETF protocol meets the described criteria. Therefore, the survey concludes that new protocol specification documents have to be defined for a LLN routing protocol.


\begin{table}[htp]
\begin{center}
        \begin{tabular}{|l|c|c|c|c|c|}
          \hline
          Protocol   &   State &  Loss & Control &  Link Cost & Node Cost\\
          \hline
          \hline
     OSPF/IS-IS  &  fail  &  fail  &  fail   &   pass    &   fail\\
     OLSRv2      &  fail  &   ?    &   ?     &   pass    &   pass\\
     TBRPF       &  fail  &  pass  &  fail   &   pass    &    ?\\
     RIP         &  pass  &  fail  &  pass   &    ?      &   fail\\
     AODV        &  pass  &  fail  &  pass   &   fail    &   fail\\
     DYMO        &  pass  &   ?    &  pass   &    ?      &    ?\\
     DSR         &  fail  &  pass  &  pass   &   fail    &   fail\\
          \hline
        \end{tabular}
\end{center}
\caption{Routing protocol survey results}\label{table:routing.prot.survey}
\end{table}


\section{IPv6 Routing Protocol for Low power and Lossy Networks}\label{sec:rout.rpl}
\subsection{Terminology}
The IPv6 Routing Protocol for Low power and Lossy Networks (RPL) introduces a notion of a Directed Acyclic Graph (DAG), which is a directed graph with no cycles exist. All edges of a DAG are oriented toward and terminating at one or more root nodes. A Destination Oriented DAG (DODAG) is a DAG rooted at a single destination, which is a node with no outgoing edges.  Each root has a unique identifier, the DAGID. While constructing a DODAG various routing metrics and optimization objectives can be used, which are defined by Objective Function (OF) \cite{draft-routing-metrics-04}.  The Objective Code Point (OCP) is used to indicate which OF is in use in a DODAG. A DAG Instance is a set of possibly multiple DODAGs. A DAG Instance is uniquely identified by InstanceID. 

\subsection{Model}
Each DAG instance constructs a routing topology optimized for a certain OF. Traffic that belongs to a specific DODAG Instance is marked in the flow label of the IPv6 header. A network may have more than one DAG Instance which operate independently. Applications may tag traffic to follow an appropriate DAG instance, i.e., optimized for low latency or low energy.  

RPL nodes construct and maintain DODAGs via exchange of DAG Information Object (DIO) messages. A DIO message identifies the DAG Instance, the DAGID, and the values used to compute the DAG Instance's objective function. The DIO also includes a measure derived from the position of the node within the DODAG, the rank, used to determine its position relative to each other and to avoid loops. The rate at which DIO messages are sent varies depending on the state of the DODAG. When a DODAG is detected to be inconsistent, the RPL sends DIO messages more frequently, and, otherwise, when the DODAG is in a stable state.



\subsection{Messages}
The draft \cite{draft-rpl-04} defines the RPL Control Message, which is a new ICMPv6 message. The format of this message is shown in Figure \ref{fig:rpl.control.message}.
\begin{figure}[htp]
\begin{mylisting}
\begin{verbatim}
   0                   1                   2                   3
   0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |     Type      |     Code      |          Checksum             |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                                                               |
   +                         Message Body                          +
   |                                                               |
\end{verbatim}
\end{mylisting}
\caption{RPL Control Message}\label{fig:rpl.control.message}
\end{figure}

The Type for the RPL Control message has the value of 155. The Code identifies the RPL Control Messages as follows:  0x01 -- DAG Information Solicitation; 0x02: DAG Information Object; 0x04: Destination Advertisement Object. The DAG Information Solicitation (DIS) message is used to solicit a DAG Information Object from a RPL node. The DAG Information Object carries a number of metrics and other information that allows a node to discover a DAG Instance, select its DAG parents, and avoid loops. The Destination Advertisement Object (DAO) is used to propagate destination information upwards along the DODAG. The format of these messages is specified in the internet draft \cite{draft-rpl-04}.

\subsection{Routing Metrics}
Historically, IGP such as OSPF ([RFC2328]) and IS-IS ([RFC1195]) have used quantitative static link metric

